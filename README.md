# 群聊扫把星（test_plugin）

一个基于 **AstrBot v4.x** 的群聊娱乐插件，用于学习与演示插件开发，包含群互动、每日运势、排行榜等功能。

## 插件信息

- **插件名**：test_plugin
- **作者**：Bricks0411
- **版本**：0.0.3
- **适配框架**：AstrBot v4.9.0
- **平台**：NapCat / aiocqhttp（WebSocket 反向连接）

## 功能列表

#### 今日运势

- 指令：

  ```
  /今日运势
  /运势
  ```

- 功能说明：

  - 每人每天固定一个运势（不可刷）
  - 运势基于 `QQ号 + 日期` 生成
  - 包含：
    - 幸运值（1~100）
    - 运势等级（大吉 / 中吉 / 小吉 / 平 / 凶）
    - 今日宜 / 忌
  - 当幸运值 ≥ 90 时触发「诸事皆宜」

示例输出：

```
【今日运势】
用户：Alice
🍀 今日人品：88
📈 运势：中吉
✅ 宜：摸鱼
❌ 忌：加班
```

#### 今日运势排行榜

- 指令：

  ```
  /运势排行
  /今日运势排行
  /运势排行榜
  ```

- 功能说明：

  - 按当日运势值排序
  - 显示前 10 名
  - 🥇🥈🥉 自动标注前三名
  - 排行数据按天存储

功能示例：

```
【今日运势排行榜】
🥇 Alice  99
🥈 Bob    92
🥉 Carol  87
4️⃣ Dave   76
```

#### 特殊问候

- 自动触发，无需指令，群聊/私聊均支持；
- 支持关键词：
  - 早安类：`早安 / 早上好 / good morning ...`
  - 晚安类：`晚安 / good night / wanan ...`
- 内置 **傲娇风格回复**。

#### 伪造发言（娱乐）

- 指令格式：

  ```
  @Bot /说 @某人 内容
  ```

- 功能说明：

  - 让 Bot 以**指定群成员的名义**发送消息；
  - 仅供娱乐，请谨慎使用。

#### 简单数学指令（示例）

- 加法：

  ```
  /add 1 2
  ```

- 减法：

  ```
  /sub 5 3
  ```

## 数据存储说明

#### 运势排行榜文件

- 路径：

  ```
  data/plugins/test_plugin-main/fortune_rank.json
  ```

- 数据结构示例：

```json
{
  "2026-01-03": {
    "123456": {
      "name": "Alice",
      "luck": 88
    }
  }
}
```

## 并发安全说明

- 使用 `asyncio.Lock` 保证排行榜写入互斥；
- 使用 `tempfile + os.replace` 实现**文件写入原子化**；
- 避免高并发场景下数据损坏。

## 安装方法

1. 将插件文件夹放入：

   ```
   AstrBot/data/plugins/
   ```

2. 启动 AstrBot；

3. 在 WebUI 中确认插件已加载；

4. 在群内测试指令。

## 注意事项

- 本插件主要用于**学习与测试**；
- **伪造发言功能可能引发误会，请谨慎使用**；
- 不建议在超大群直接开启娱乐刷屏功能。

## TODO

#### 每日运势

- **图片渲染**排行榜；
- 运势红黑榜；
- 连续运势成就；
- 群专属彩蛋 / 群主特权；
- 基于LLM的运势锐评。

#### 伪造发言

- 实现多条伪造消息的拼接/嵌套。

#### 特殊问候

- 实现基于LLM的特殊早晚问候。

#### AstrBot

- WebUI 配置开关。

## License

MIT / 学习用途自由修改